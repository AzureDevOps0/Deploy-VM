trigger:
- main

pool:
  WindowsAgent: agent-1

variables:
  ARM_CLIENT_ID: $(servicePrincipalId)
  ARM_CLIENT_SECRET: $(servicePrincipalKey)
  ARM_SUBSCRIPTION_ID: $(subscriptionId)
  ARM_TENANT_ID: $(tenantId)

stages:
- stage: Build
  jobs:
  - job: BuildJob
    steps:
    - task: ms-devlabs.custom-terraform-tasks.custom-terraform-installer-task.TerraformInstaller@1
      displayName: Install-Terraform
      inputs:
        terraformVersion: 'latest'
    - task: TerraformTaskV4@4
      displayName: Initialize-Provider
      inputs:
        provider: 'azurerm'
        command: 'init'
        backendServiceArm: 'deploy-Vm'
        backendAzureRmResourceGroupName: 'Safi_rg'
        backendAzureRmStorageAccountName: 'tfstatefilessacloud'
        backendAzureRmContainerName: 'tfstatefile'
        backendAzureRmKey: 'terraform.tfstatefile'
    - task: TerraformTaskV4@4
      displayName: Plan
      inputs:
        provider: 'azurerm'
        command: 'plan'
        environmentServiceNameAzureRM: 'deploy-Vm'
    - script: echo "Copy files to staging directory" && cp -r $(Build.SourcesDirectory)/* $(Build.ArtifactStagingDirectory)
      displayName: 'Copy files to staging directory'
    - script: ls -la $(Build.ArtifactStagingDirectory)
      displayName: 'List files in staging directory'
    - task: PublishPipelineArtifact@1
      displayName: 'Publish Pipeline Artifact'
      inputs:
        targetPath: '$(Build.ArtifactStagingDirectory)'
        artifact: 'terraform-config'

- stage: Deploy
  dependsOn: Build
  jobs:
  - deployment: DeployToProduction
    displayName: 'Deploy to Production'
    environment: 'Approvers' # Reference to the environment with the approval
    strategy:
      runOnce:
        deploy:
          steps:
          - download: current
            artifact: terraform-config
          - script: ls -la $(Pipeline.Workspace)/terraform-config
            displayName: 'List extracted files'
          - script: |
              cd $(Pipeline.Workspace)/terraform-config
              export ARM_CLIENT_ID=$(ARM_CLIENT_ID)
              export ARM_CLIENT_SECRET=$(ARM_CLIENT_SECRET)
              export ARM_SUBSCRIPTION_ID=$(ARM_SUBSCRIPTION_ID)
              export ARM_TENANT_ID=$(ARM_TENANT_ID)
              terraform init -reconfigure
            displayName: Initialize Terraform Backend
          - script: |
              cd $(Pipeline.Workspace)/terraform-config
              export ARM_CLIENT_ID=$(ARM_CLIENT_ID)
              export ARM_CLIENT_SECRET=$(ARM_CLIENT_SECRET)
              export ARM_SUBSCRIPTION_ID=$(ARM_SUBSCRIPTION_ID)
              export ARM_TENANT_ID=$(ARM_TENANT_ID)
              terraform apply -auto-approve
            displayName: Apply Terraform Configuration
